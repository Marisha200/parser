<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parseador Inteligente de XML a Tabla v6.1 (Bugfix)</title>
    <style>
        /* (El CSS es el mismo que en la versi√≥n anterior, no es necesario cambiarlo) */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f9;color:#333;margin:0;padding:20px;display:flex;justify-content:center}
        .container{width:90%;max-width:900px;background-color:#fff;padding:30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
        h1{color:#1a2533;text-align:center;margin-top:0;margin-bottom:20px;font-size:2rem}
        button#generarBtn{display:block;width:100%;padding:12px;background-color:#28a745;color:#fff;border:none;border-radius:5px;font-size:16px;font-weight:700;cursor:pointer;transition:background-color .3s}
        button#generarBtn:hover{background-color:#218838}
        .textarea-container{position:relative;margin-bottom:15px}
        textarea#xmlInput{width:100%;height:250px;padding:10px 40px 10px 10px;border:1px solid #ccc;border-radius:5px;font-family:"Courier New",Courier,monospace;font-size:14px;box-sizing:border-box;resize:vertical}
        button#borrarBtn{position:absolute;top:10px;right:10px;width:auto;padding:2px 8px;background-color:#e9ecef;color:#495057;border:1px solid #ced4da;font-size:18px;font-weight:700;line-height:1;opacity:.7;transition:opacity .3s,background-color .3s}
        button#borrarBtn:hover{opacity:1;background-color:#ced4da}
        #tablaContenedor{margin-top:25px;overflow-x:auto}
        .tabla-resultado{width:100%;border-collapse:collapse;border:1px solid #ddd}
        .tabla-resultado th,.tabla-resultado td{border:1px solid #ddd;padding:10px;text-align:left;word-break:break-all}
        .tabla-resultado th{background-color:#e9ecef;font-weight:700}
        .error{color:#d93025;background-color:#fbe9e7;border:1px solid #d93025;padding:10px;border-radius:5px;margin-top:15px}
        #scrollTopBtn{display:none;position:fixed;bottom:20px;right:20px;z-index:99;border:none;outline:0;background-color:#007bff;color:#fff;cursor:pointer;border-radius:50%;font-size:20px;box-shadow:0 2px 5px rgba(0,0,0,.3);width:45px;height:45px;display:flex;align-items:center;justify-content:center;padding:0}
        #scrollTopBtn:hover{background-color:#0056b3}
        @media screen and (max-width:768px){body{padding:10px}.container{width:100%;padding:15px}h1{font-size:1.5rem}#scrollTopBtn{bottom:15px;right:15px;width:40px;height:40px}}
    </style>
</head>
<body>

    <div class="container">
        <h1>üêû Parseador de XML v6.1</h1>
        <p>Pega tu XML aqu√≠. La herramienta es tolerante a texto introductorio y a formatos de string con comillas.</p>
        
        <div class="textarea-container">
            <textarea id="xmlInput" placeholder="Pega aqu√≠ tu texto XML..."></textarea>
            <button id="borrarBtn" title="Borrar contenido">&times;</button>
        </div>
        
        <button id="generarBtn" id="generarBtn">üñ±Ô∏è Limpiar y Generar Tabla</button>

        <div id="tablaContenedor"></div>
    </div>

    <button id="scrollTopBtn" title="Ir arriba">&#8679;</button>

    <script>
        const generarBtn = document.getElementById('generarBtn');
        const borrarBtn = document.getElementById('borrarBtn');
        const xmlInput = document.getElementById('xmlInput');
        const tablaContenedor = document.getElementById('tablaContenedor');
        const scrollTopBtn = document.getElementById('scrollTopBtn');

        borrarBtn.addEventListener('click', function() {
            xmlInput.value = '';
            tablaContenedor.innerHTML = '';
            xmlInput.focus();
        });
        window.onscroll = function() {
            if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
                scrollTopBtn.style.display = "flex";
            } else {
                scrollTopBtn.style.display = "none";
            }
        };
        scrollTopBtn.addEventListener('click', function() {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
        
        generarBtn.addEventListener('click', function() {
            let rawString = xmlInput.value;
            tablaContenedor.innerHTML = '';

            if (!rawString.trim()) {
                tablaContenedor.innerHTML = `<p class="error">Por favor, pega contenido XML en el √°rea de texto.</p>`;
                return;
            }

            // --- INICIO DE LA CORRECCI√ìN ---
            // Nueva secuencia de limpieza m√°s robusta
            let processedString = rawString.trim();

            // 1. PRIMERO, maneja el caso de que todo el texto sea un string literal (envuelto en comillas).
            // Esto es crucial para que el siguiente paso funcione correctamente.
            if (processedString.startsWith('"') && processedString.endsWith('"')) {
                processedString = processedString.substring(1, processedString.length - 1); // Quita las comillas de los extremos
                processedString = processedString.replace(/""/g, '"'); // Arregla las comillas internas duplicadas
            }

            // 2. SEGUNDO, busca el inicio real del XML ('<') para quitar cualquier texto introductorio.
            const startIndex = processedString.indexOf('<');
            if (startIndex === -1) {
                tablaContenedor.innerHTML = `<p class="error">Error: El texto no contiene un inicio de XML v√°lido (&lt;).</p>`;
                return;
            }

            // 3. La cadena final y limpia que se pasar√° al parser.
            const xmlString = processedString.substring(startIndex);
            // --- FIN DE LA CORRECCI√ìN ---


            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");

                if (xmlDoc.getElementsByTagName("parsererror").length) {
                    throw new Error("El XML proporcionado no es v√°lido. Revisa la sintaxis despu√©s de la limpieza autom√°tica.");
                }

                const flatData = [];
                function procesarNodo(node, path) {
                    if (node.nodeType !== 1) return;
                    if (node.children.length > 0) {
                        for (const child of node.children) {
                            procesarNodo(child, `${path}.${child.tagName}`);
                        }
                    } else {
                        const value = node.textContent.trim();
                        if (value) { flatData.push({ path: path, value: value }); }
                    }
                }
                
                procesarNodo(xmlDoc.documentElement, xmlDoc.documentElement.tagName);

                const resultadosAgrupados = new Map();
                for (const item of flatData) {
                    if (resultadosAgrupados.has(item.path)) {
                        const valorExistente = resultadosAgrupados.get(item.path);
                        resultadosAgrupados.set(item.path, `${valorExistente}, ${item.value}`);
                    } else {
                        resultadosAgrupados.set(item.path, item.value);
                    }
                }

                if (resultadosAgrupados.size === 0) {
                     throw new Error("No se encontraron datos extra√≠bles en el XML.");
                }

                let tablaHTML = '<table class="tabla-resultado"><thead><tr><th>Clave (Contexto)</th><th>Valor</th></tr></thead><tbody>';
                
                for (const [claveCompleta, valor] of resultadosAgrupados.entries()) {
                     const parts = claveCompleta.split('.');
                     const claveConContexto = parts.length > 1 ? parts.slice(-2).join('.') : parts[0];
                     tablaHTML += `<tr><td>${claveConContexto}</td><td>${valor}</td></tr>`;
                }
                tablaHTML += '</tbody></table>';
                tablaContenedor.innerHTML = tablaHTML;

            } catch (e) {
                tablaContenedor.innerHTML = `<p class="error"><strong>Error:</strong> ${e.message}</p>`;
            }
        });
    </script>

</body>
</html>
